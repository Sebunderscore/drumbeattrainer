<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Drumbeat Trainer</title>
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --bg-glass: rgba(44, 44, 46, 0.72);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --accent-blue: #0a84ff;
            --accent-green: #30d158;
            --accent-orange: #ff9f0a;
            --accent-red: #ff453a;
            --accent-purple: #bf5af2;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: var(--text-primary);
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .container {
            max-width: 920px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: clamp(28px, 8vw, 48px);
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.7) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: clamp(14px, 4vw, 17px);
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Glass Card */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Controls Section */
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-value {
            font-size: clamp(24px, 6vw, 34px);
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .control-value span {
            font-size: clamp(14px, 4vw, 17px);
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Slider */
        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
            margin-top: 8px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow-color), 0 0 0 1px rgba(0,0,0,0.1);
        }

        /* Number Input */
        input[type="number"] {
            width: 80px;
            padding: 10px 12px;
            border: none;
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            outline: none;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"]:focus {
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 14px 24px;
            border: none;
            border-radius: 980px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
        }

        .btn-generate {
            background: var(--accent-red);
            color: #fff;
        }

        .btn-generate:hover {
            background: #ff6961;
            transform: scale(1.02);
        }

        .btn-generate:active {
            transform: scale(0.98);
        }

        .btn-play {
            background: var(--accent-green);
            color: #fff;
        }

        .btn-play:hover {
            background: #34d65c;
            transform: scale(1.02);
        }

        .btn-play:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #3a3a3c;
        }

        .btn-secondary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-check {
            background: var(--accent-blue);
            color: #fff;
        }

        .btn-check:hover {
            background: #409cff;
            transform: scale(1.02);
        }

        .btn-check:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* Section Title */
        .section-title {
            font-size: clamp(18px, 5vw, 22px);
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        /* Instructions */
        .instructions {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        /* Beat Grid */
        .grid-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 8px;
            margin: 0 -20px;
            padding: 0 20px 8px 20px;
        }

        .grid-wrapper {
            display: inline-block;
            min-width: 100%;
        }

        .step-numbers {
            display: flex;
            gap: 3px;
            margin-left: 56px;
            margin-bottom: 6px;
        }

        .step-number {
            width: 28px;
            text-align: center;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }

        .step-number.downbeat {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .beat-grid {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .grid-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .instrument-label {
            width: 50px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            text-align: right;
            flex-shrink: 0;
        }

        .steps-container {
            display: flex;
            gap: 3px;
        }

        .step {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
            border: none;
            flex-shrink: 0;
        }

        /* Instrument Colors */
        .step.kick {
            background: rgba(255, 69, 58, 0.15);
        }
        .step.snare {
            background: rgba(10, 132, 255, 0.15);
        }
        .step.hihat {
            background: rgba(255, 159, 10, 0.15);
        }

        /* Active states */
        .step.kick.active {
            background: var(--accent-red);
            box-shadow: 0 2px 8px rgba(255, 69, 58, 0.4);
        }
        .step.snare.active {
            background: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(10, 132, 255, 0.4);
        }
        .step.hihat.active {
            background: var(--accent-orange);
            box-shadow: 0 2px 8px rgba(255, 159, 10, 0.4);
        }

        /* Touch feedback */
        .step:active {
            transform: scale(0.9);
        }

        /* Playing animation */
        .step.playing {
            animation: pulse 0.12s ease;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); filter: brightness(1.3); }
            100% { transform: scale(1); }
        }

        /* Correct/Incorrect feedback */
        .step.correct::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 8px;
            border: 2px solid var(--accent-green);
            pointer-events: none;
        }

        .step.incorrect::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 8px;
            border: 2px solid var(--accent-red);
            pointer-events: none;
            animation: shake 0.3s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.kick { background: var(--accent-red); }
        .legend-dot.snare { background: var(--accent-blue); }
        .legend-dot.hihat { background: var(--accent-orange); }

        /* Result Section */
        .result-section {
            display: none;
        }

        .result-section.visible {
            display: block;
        }

        .score-display {
            text-align: center;
            padding: 24px 0;
        }

        .score-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .score-value {
            font-size: clamp(48px, 15vw, 72px);
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), #34d65c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-value.medium {
            background: linear-gradient(135deg, var(--accent-orange), #ffb340);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-value.low {
            background: linear-gradient(135deg, var(--accent-red), #ff6961);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .result-divider {
            height: 1px;
            background: var(--border-color);
            margin: 20px 0;
        }

        .result-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        /* Responsive - Tablet */
        @media (min-width: 600px) {
            .step {
                width: 36px;
                height: 36px;
                border-radius: 8px;
            }

            .step-number {
                width: 36px;
                font-size: 11px;
            }

            .step-numbers {
                margin-left: 70px;
                gap: 4px;
            }

            .steps-container {
                gap: 4px;
            }

            .instrument-label {
                width: 62px;
                font-size: 13px;
            }

            .card {
                padding: 24px;
            }
        }

        /* Responsive - Desktop */
        @media (min-width: 800px) {
            body {
                padding: 40px 20px;
            }

            .header {
                margin-bottom: 48px;
            }

            .step {
                width: 44px;
                height: 44px;
                border-radius: 10px;
            }

            .step-number {
                width: 44px;
                font-size: 12px;
            }

            .step-numbers {
                margin-left: 88px;
            }

            .instrument-label {
                width: 80px;
                font-size: 14px;
            }

            .card {
                padding: 28px;
            }

            .button-group {
                flex-direction: row;
            }

            button {
                width: auto;
            }
        }

        /* Mobile specific */
        @media (max-width: 599px) {
            .controls-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .grid-container {
                margin: 0 -20px;
                padding: 0 20px 12px 20px;
            }
        }

        /* Dark mode scrollbar */
        ::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Drumbeat Trainer</h1>
            <p>Train your rhythm skills for electronic music production</p>
        </header>

        <div class="card">
            <div class="controls-grid">
                <div class="control-group">
                    <label class="control-label">Difficulty</label>
                    <div class="control-value"><span id="difficultyValue">3</span><span>/ 10</span></div>
                    <input type="range" id="difficulty" min="1" max="10" value="3">
                </div>
                <div class="control-group">
                    <label class="control-label">Tempo</label>
                    <div class="control-value">
                        <input type="number" id="tempo" value="120" min="60" max="200">
                        <span>BPM</span>
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn-generate" id="generateBtn">Generate Beat</button>
                <button class="btn-play" id="playTargetBtn" disabled>Play Beat</button>
            </div>
        </div>

        <p class="instructions" id="instructions">
            Tap "Generate Beat" to start. Listen to the beat and recreate it in the grid below.
        </p>

        <div class="card" id="inputSection">
            <h2 class="section-title">Your Answer</h2>
            <div class="grid-container">
                <div class="grid-wrapper">
                    <div class="step-numbers" id="stepNumbers"></div>
                    <div class="beat-grid" id="inputGrid"></div>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot kick"></div> Kick</div>
                <div class="legend-item"><div class="legend-dot snare"></div> Snare</div>
                <div class="legend-item"><div class="legend-dot hihat"></div> Hi-Hat</div>
            </div>
            <div style="margin-top: 20px;">
                <div class="button-group">
                    <button class="btn-secondary" id="playInputBtn">Play Your Beat</button>
                    <button class="btn-secondary" id="clearBtn">Clear All</button>
                    <button class="btn-check" id="checkBtn" disabled>Check Answer</button>
                </div>
            </div>
        </div>

        <div class="result-section card" id="resultSection">
            <div class="score-display">
                <div class="score-label">Score</div>
                <div class="score-value" id="scoreDisplay">100%</div>
            </div>
            <div class="result-divider"></div>
            <div class="result-label">Correct Beat</div>
            <div class="grid-container">
                <div class="grid-wrapper">
                    <div class="step-numbers" id="targetStepNumbers"></div>
                    <div class="beat-grid" id="targetGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Audio Context
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // Drum Synthesis
        function playKick(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.frequency.setValueAtTime(150, time);
            osc.frequency.exponentialRampToValueAtTime(30, time + 0.1);

            gain.gain.setValueAtTime(1, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.3);

            osc.start(time);
            osc.stop(time + 0.3);
        }

        function playSnare(time) {
            const bufferSize = audioCtx.sampleRate * 0.2;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;

            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'highpass';
            noiseFilter.frequency.value = 1000;

            const noiseGain = audioCtx.createGain();
            noiseGain.gain.setValueAtTime(0.8, time);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, time + 0.15);

            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(audioCtx.destination);

            const osc = audioCtx.createOscillator();
            const oscGain = audioCtx.createGain();
            osc.frequency.value = 200;
            oscGain.gain.setValueAtTime(0.5, time);
            oscGain.gain.exponentialRampToValueAtTime(0.01, time + 0.1);

            osc.connect(oscGain);
            oscGain.connect(audioCtx.destination);

            noise.start(time);
            noise.stop(time + 0.2);
            osc.start(time);
            osc.stop(time + 0.1);
        }

        function playHihat(time) {
            const bufferSize = audioCtx.sampleRate * 0.05;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;

            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 7000;

            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.3, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);

            noise.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);

            noise.start(time);
            noise.stop(time + 0.05);
        }

        // State
        let targetBeat = { kick: [], snare: [], hihat: [] };
        let userBeat = { kick: [], snare: [], hihat: [] };
        const STEPS = 16;

        // Initialize grids
        function initGrid(gridId, beat, editable = false) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            ['hihat', 'snare', 'kick'].forEach(instrument => {
                const row = document.createElement('div');
                row.className = 'grid-row';

                const label = document.createElement('div');
                label.className = 'instrument-label';
                label.textContent = instrument.charAt(0).toUpperCase() + instrument.slice(1);
                row.appendChild(label);

                const stepsContainer = document.createElement('div');
                stepsContainer.className = 'steps-container';

                for (let i = 0; i < STEPS; i++) {
                    const step = document.createElement('div');
                    step.className = `step ${instrument}`;
                    step.dataset.instrument = instrument;
                    step.dataset.step = i;

                    if (beat[instrument][i]) {
                        step.classList.add('active');
                    }

                    if (editable) {
                        // Support both click and touch
                        step.addEventListener('click', (e) => {
                            e.preventDefault();
                            toggleStep(instrument, i, step);
                        });
                    }

                    stepsContainer.appendChild(step);
                }

                row.appendChild(stepsContainer);
                grid.appendChild(row);
            });
        }

        function initStepNumbers(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for (let i = 0; i < STEPS; i++) {
                const num = document.createElement('div');
                num.className = `step-number ${i % 4 === 0 ? 'downbeat' : ''}`;
                num.textContent = i + 1;
                container.appendChild(num);
            }
        }

        function toggleStep(instrument, step, element) {
            userBeat[instrument][step] = !userBeat[instrument][step];
            element.classList.toggle('active');
        }

        // Beat Generation based on difficulty
        // Now with randomization at ALL difficulty levels
        function generateBeat(difficulty) {
            const beat = {
                kick: new Array(STEPS).fill(false),
                snare: new Array(STEPS).fill(false),
                hihat: new Array(STEPS).fill(false)
            };

            const pickRandom = (arr, count) => {
                const shuffled = [...arr].sort(() => Math.random() - 0.5);
                return shuffled.slice(0, Math.min(count, arr.length));
            };

            const coinFlip = (probability = 0.5) => Math.random() < probability;

            // All possible positions
            const downbeats = [0, 4, 8, 12];
            const backbeats = [4, 12];
            const eighthNotes = [0, 2, 4, 6, 8, 10, 12, 14];
            const syncopatedKickPositions = [3, 6, 7, 10, 11, 14, 15];
            const syncopatedSnarePositions = [2, 3, 6, 7, 10, 11, 14, 15];
            const offbeatHihatPositions = [1, 3, 5, 7, 9, 11, 13, 15];

            // === DIFFICULTY 1: Simple but varied ===
            if (difficulty === 1) {
                // Always kick on 1
                beat.kick[0] = true;
                // Randomly add kick on 3 (50% chance)
                if (coinFlip(0.5)) beat.kick[8] = true;

                // Snare always on 2 and 4
                beat.snare[4] = true;
                beat.snare[12] = true;

                // Hi-hat pattern: randomly choose between different simple patterns
                const hihatPattern = Math.floor(Math.random() * 3);
                if (hihatPattern === 0) {
                    // Quarter notes
                    [0, 4, 8, 12].forEach(pos => beat.hihat[pos] = true);
                } else if (hihatPattern === 1) {
                    // Just on 1 and 3
                    [0, 8].forEach(pos => beat.hihat[pos] = true);
                } else {
                    // On backbeats with kick
                    [0, 4, 8, 12].forEach(pos => beat.hihat[pos] = true);
                    if (coinFlip(0.5)) beat.hihat[8] = false;
                }
            }

            // === DIFFICULTY 2: Basic with variation ===
            if (difficulty === 2) {
                // Kick pattern variations
                beat.kick[0] = true;
                beat.kick[8] = coinFlip(0.7);
                // Sometimes add a kick on beat 4
                if (coinFlip(0.3)) beat.kick[12] = true;

                // Snare on backbeats
                beat.snare[4] = true;
                beat.snare[12] = true;

                // Hi-hats on quarter notes with random omissions
                [0, 4, 8, 12].forEach(pos => {
                    beat.hihat[pos] = coinFlip(0.85);
                });
                // Ensure at least 2 hi-hats
                if (beat.hihat.filter(x => x).length < 2) {
                    beat.hihat[0] = true;
                    beat.hihat[8] = true;
                }
            }

            // === DIFFICULTY 3: 8th note hi-hats with variation ===
            if (difficulty === 3) {
                // Basic kick pattern with variation
                beat.kick[0] = true;
                beat.kick[8] = coinFlip(0.6);

                // Snares
                beat.snare[4] = true;
                beat.snare[12] = true;

                // 8th note hi-hats with some randomly removed
                eighthNotes.forEach(pos => {
                    beat.hihat[pos] = coinFlip(0.8);
                });
                // Ensure downbeats have hi-hats
                beat.hihat[0] = true;
                beat.hihat[4] = coinFlip(0.9);
            }

            // === DIFFICULTY 4: First syncopation ===
            if (difficulty === 4) {
                // Kick with one syncopation
                beat.kick[0] = true;
                beat.kick[8] = coinFlip(0.5);
                const syncKick = pickRandom([6, 14], 1);
                syncKick.forEach(pos => beat.kick[pos] = true);

                // Snares
                beat.snare[4] = true;
                beat.snare[12] = true;

                // 8th note hi-hats
                eighthNotes.forEach(pos => {
                    beat.hihat[pos] = coinFlip(0.85);
                });
            }

            // === DIFFICULTY 5-6: More syncopation ===
            if (difficulty === 5 || difficulty === 6) {
                // Syncopated kicks
                beat.kick[0] = coinFlip(0.8);
                beat.kick[8] = coinFlip(0.5);
                const numSyncKicks = difficulty === 5 ? 1 + Math.floor(Math.random() * 2) : 2;
                const syncKicks = pickRandom(syncopatedKickPositions, numSyncKicks);
                syncKicks.forEach(pos => beat.kick[pos] = true);

                // Snares
                beat.snare[4] = true;
                beat.snare[12] = true;

                // 8th notes + some 16ths
                eighthNotes.forEach(pos => beat.hihat[pos] = true);
                const extraHihats = pickRandom(offbeatHihatPositions, difficulty - 3);
                extraHihats.forEach(pos => beat.hihat[pos] = true);
            }

            // === DIFFICULTY 7-8: Ghost notes and complex patterns ===
            if (difficulty === 7 || difficulty === 8) {
                // Complex kick pattern
                beat.kick[0] = coinFlip(0.7);
                beat.kick[8] = coinFlip(0.4);
                const syncKicks = pickRandom(syncopatedKickPositions, 2 + Math.floor(Math.random() * 2));
                syncKicks.forEach(pos => beat.kick[pos] = true);

                // Ghost snares
                beat.snare[4] = coinFlip(0.9);
                beat.snare[12] = coinFlip(0.9);
                const ghostSnares = pickRandom([2, 6, 10, 14], 1 + Math.floor(Math.random() * 2));
                ghostSnares.forEach(pos => beat.snare[pos] = true);

                // Hi-hats with gaps
                for (let i = 0; i < STEPS; i++) {
                    beat.hihat[i] = coinFlip(0.75);
                }
            }

            // === DIFFICULTY 9-10: Maximum syncopation ===
            if (difficulty >= 9) {
                // Very syncopated kicks
                beat.kick[0] = coinFlip(0.4);
                beat.kick[8] = coinFlip(0.3);
                const heavyKicks = pickRandom(syncopatedKickPositions, 3 + Math.floor(Math.random() * 2));
                heavyKicks.forEach(pos => beat.kick[pos] = true);

                // Anticipated/displaced snares
                if (coinFlip(0.6)) {
                    beat.snare[3] = true;
                } else {
                    beat.snare[4] = true;
                }
                if (coinFlip(0.6)) {
                    beat.snare[11] = true;
                } else {
                    beat.snare[12] = true;
                }

                // Extra syncopated snares
                const extraSnares = pickRandom(syncopatedSnarePositions, 1 + Math.floor(Math.random() * 2));
                extraSnares.forEach(pos => beat.snare[pos] = true);

                // Hi-hats with interesting gaps
                for (let i = 0; i < STEPS; i++) {
                    if (i % 4 === 0) {
                        beat.hihat[i] = coinFlip(0.5); // Gaps on downbeats
                    } else {
                        beat.hihat[i] = coinFlip(0.7);
                    }
                }
            }

            // Ensure at least one kick
            if (!beat.kick.includes(true)) {
                beat.kick[pickRandom([0, 3, 7, 11], 1)[0]] = true;
            }

            // Ensure at least one snare
            if (!beat.snare.includes(true)) {
                beat.snare[4] = true;
            }

            return beat;
        }

        // Playback
        let isPlaying = false;

        async function playBeat(beat, highlightGrid = null) {
            if (isPlaying) return;
            isPlaying = true;

            initAudio();

            const tempo = parseInt(document.getElementById('tempo').value);
            const stepDuration = (60 / tempo) / 4;

            const startTime = audioCtx.currentTime + 0.1;

            for (let i = 0; i < STEPS; i++) {
                const time = startTime + (i * stepDuration);

                if (beat.kick[i]) playKick(time);
                if (beat.snare[i]) playSnare(time);
                if (beat.hihat[i]) playHihat(time);

                if (highlightGrid) {
                    setTimeout(() => {
                        highlightStep(highlightGrid, i);
                    }, (time - audioCtx.currentTime) * 1000);
                }
            }

            setTimeout(() => {
                isPlaying = false;
                if (highlightGrid) {
                    clearHighlights(highlightGrid);
                }
            }, STEPS * stepDuration * 1000 + 100);
        }

        function highlightStep(gridId, step) {
            const grid = document.getElementById(gridId);
            const steps = grid.querySelectorAll('.step');

            steps.forEach(s => s.classList.remove('playing'));

            steps.forEach(s => {
                if (parseInt(s.dataset.step) === step) {
                    s.classList.add('playing');
                }
            });
        }

        function clearHighlights(gridId) {
            const grid = document.getElementById(gridId);
            grid.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
        }

        // Check answer
        function checkAnswer() {
            let correct = 0;
            let total = 0;

            const inputGrid = document.getElementById('inputGrid');
            const steps = inputGrid.querySelectorAll('.step');

            steps.forEach(step => {
                step.classList.remove('correct', 'incorrect');
            });

            ['hihat', 'snare', 'kick'].forEach(instrument => {
                for (let i = 0; i < STEPS; i++) {
                    const targetValue = targetBeat[instrument][i];
                    const userValue = userBeat[instrument][i];

                    if (targetValue || userValue) {
                        total++;
                        const stepEl = inputGrid.querySelector(
                            `.step[data-instrument="${instrument}"][data-step="${i}"]`
                        );

                        if (targetValue === userValue) {
                            correct++;
                            if (targetValue) stepEl.classList.add('correct');
                        } else {
                            stepEl.classList.add('incorrect');
                        }
                    }
                }
            });

            const score = total > 0 ? Math.round((correct / total) * 100) : 0;

            const resultSection = document.getElementById('resultSection');
            resultSection.classList.add('visible');

            const scoreDisplay = document.getElementById('scoreDisplay');
            scoreDisplay.textContent = `${score}%`;
            scoreDisplay.className = 'score-value';
            if (score < 50) scoreDisplay.classList.add('low');
            else if (score < 80) scoreDisplay.classList.add('medium');

            initStepNumbers('targetStepNumbers');
            initGrid('targetGrid', targetBeat, false);

            // Scroll to results on mobile
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Event Listeners
        document.getElementById('difficulty').addEventListener('input', (e) => {
            document.getElementById('difficultyValue').textContent = e.target.value;
        });

        document.getElementById('generateBtn').addEventListener('click', () => {
            initAudio();
            const difficulty = parseInt(document.getElementById('difficulty').value);
            targetBeat = generateBeat(difficulty);

            userBeat = {
                kick: new Array(STEPS).fill(false),
                snare: new Array(STEPS).fill(false),
                hihat: new Array(STEPS).fill(false)
            };

            initGrid('inputGrid', userBeat, true);
            document.getElementById('resultSection').classList.remove('visible');

            document.getElementById('playTargetBtn').disabled = false;
            document.getElementById('checkBtn').disabled = false;

            setTimeout(() => playBeat(targetBeat), 200);

            document.getElementById('instructions').textContent =
                'Listen to the beat and tap the grid to recreate it. Tap "Play Beat" to hear it again.';
        });

        document.getElementById('playTargetBtn').addEventListener('click', () => {
            playBeat(targetBeat);
        });

        document.getElementById('playInputBtn').addEventListener('click', () => {
            playBeat(userBeat, 'inputGrid');
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            userBeat = {
                kick: new Array(STEPS).fill(false),
                snare: new Array(STEPS).fill(false),
                hihat: new Array(STEPS).fill(false)
            };
            initGrid('inputGrid', userBeat, true);

            const inputGrid = document.getElementById('inputGrid');
            inputGrid.querySelectorAll('.step').forEach(s => {
                s.classList.remove('correct', 'incorrect');
            });
        });

        document.getElementById('checkBtn').addEventListener('click', checkAnswer);

        // Initialize
        initStepNumbers('stepNumbers');
        userBeat = {
            kick: new Array(STEPS).fill(false),
            snare: new Array(STEPS).fill(false),
            hihat: new Array(STEPS).fill(false)
        };
        initGrid('inputGrid', userBeat, true);
    </script>
</body>
</html>
